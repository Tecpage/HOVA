#!/bin/bash
set -euo pipefail

# --- resolve symlink on macOS ---
SCRIPT="$0"
if [ -L "$SCRIPT" ]; then
  TARGET="$(readlink "$SCRIPT")"
  case "$TARGET" in
    /*) SCRIPT="$TARGET" ;;
    *)  SCRIPT="$(cd "$(dirname "$SCRIPT")" && pwd)/$TARGET" ;;
  esac
fi

ROOT="$(cd "$(dirname "$SCRIPT")/.." && pwd)"
HOOKS="$ROOT/.y/hooks.sh"
REPORT="$ROOT/.y/report.txt"
TASKS="$ROOT/.y/tasks.md"

cmd="${1:-help}"
shift || true

need_git() { command -v git >/dev/null 2>&1 || { echo "git fehlt"; exit 1; }; }
need_py()  { command -v python3 >/dev/null 2>&1 || { echo "python3 fehlt"; exit 1; }; }

ensure_dirs() { mkdir -p "$ROOT/.y"; }

ensure_python_deps() {
  need_py
  python3 -m pip install --user -q ruamel.yaml jsonschema >/dev/null 2>&1 || true
}

help() {
cat <<'HLP'
y — Projekt Y CLI (ohne Editor, minimal Copy/Paste)

Discovery:
  y scan
  y files
  y status
  y diff

Automations-Basics:
  y validate          YAML parse + optional Schema (schema/schema.json)
  y format            YAML kanonisch formatieren
  y gen               Generator-Hook (.y/hooks.sh -> y_gen)
  y check             validate + format + gen + diff --stat

Weniger Copy/Paste:
  y report            schreibt .y/report.txt (status + diff summary + diff excerpt)
  y task "Text"       schreibt Task in .y/tasks.md und erzeugt report

Git-Flow:
  y branch <name>
  y commit "msg" [scope]   (nur auf Branch, inkl. check + report)

HLP
}

case "$cmd" in
  help) help ;;

  scan)
    echo "ROOT: $ROOT"
    echo
    echo "Top-level:"
    ls -la "$ROOT"
    echo
    echo "YAML:"
    find "$ROOT" -type f \( -iname "*.yaml" -o -iname "*.yml" \) \
      | grep -v '/\.git/' | sed "s|^$ROOT/||"
    ;;

  files)
    find "$ROOT" -type f \( -iname "*.yaml" -o -iname "*.yml" \) \
      | grep -v '/\.git/' | sed "s|^$ROOT/||"
    ;;

  status)
    need_git
    (cd "$ROOT" && git status -sb)
    ;;

  diff)
    need_git
    (cd "$ROOT" && git diff)
    ;;

  validate)
    ensure_python_deps
    python3 "$ROOT/cli/ytools/y_validate.py" "$ROOT"
    ;;

  format)
    ensure_python_deps
    python3 "$ROOT/cli/ytools/y_format.py" "$ROOT"
    ;;

  gen)
    ensure_dirs
    if [ -f "$HOOKS" ]; then
      # shellcheck disable=SC1090
      source "$HOOKS"
      if declare -F y_gen >/dev/null 2>&1; then
        y_gen "$ROOT"
      else
        echo "Hook-Datei existiert, aber y_gen ist nicht definiert: $HOOKS"
        exit 1
      fi
    else
      echo "Kein Hook gefunden: $HOOKS"
      exit 1
    fi
    ;;

  check)
    echo "== validate =="; "$ROOT/cli/y" validate
    echo "== format ==";   "$ROOT/cli/y" format
    echo "== gen ==";      "$ROOT/cli/y" gen
    echo "== diff --stat =="; (cd "$ROOT" && git diff --stat || true)
    ;;

  report)
    need_git
    ensure_dirs
    (cd "$ROOT" && {
      echo "## y report"
      echo
      echo "### git status"
      git status -sb
      echo
      echo "### git diff --stat"
      git diff --stat
      echo
      echo "### git diff (erste 200 Zeilen)"
      git diff | sed -n '1,200p'
    }) > "$REPORT"
    echo "Report geschrieben: .y/report.txt"
    ;;

  task)
    ensure_dirs
    text="${1:-}"
    if [ -z "$text" ]; then
      echo 'Usage: y task "Beschreibe die Aufgabe"'
      exit 1
    fi
    ts="$(TZ=Europe/Berlin date '+%Y-%m-%d %H:%M')"
    echo "- ${ts} — ${text}" >> "$TASKS"
    echo "Task notiert: .y/tasks.md"
    "$ROOT/cli/y" report
    ;;

  branch)
    need_git
    name="${1:-}"
    if [ -z "$name" ]; then
      echo "Usage: y branch <name>"
      exit 1
    fi
    (cd "$ROOT" && git checkout -b "$name" 2>/dev/null || git checkout "$name")
    ;;

  commit)
    need_git
    msg="${1:-}"
    scope="${2:-repo}"
    if [ -z "$msg" ]; then
      echo 'Usage: y commit "msg" [scope]'
      exit 1
    fi
    cd "$ROOT"
    b="$(git rev-parse --abbrev-ref HEAD)"
    if [ "$b" = "main" ] || [ "$b" = "master" ]; then
      echo "Refuse: Commit nicht auf $b. Nutze: y branch <name>"
      exit 1
    fi
    "$ROOT/cli/y" check
    "$ROOT/cli/y" report
    if git diff --quiet; then
      echo "Keine Änderungen zu committen."
      exit 0
    fi
    git add -A
    git commit -m "$msg"
    echo "Commit ok (${scope}) auf Branch: $b"
    ;;

  *)
    echo "Unknown command: $cmd"
    exit 1
    ;;
esac
